<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Teste de Visualização de Projetos</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #f5f5f5;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .tabs {
        display: flex;
        border-bottom: 1px solid #ddd;
        margin-bottom: 20px;
      }
      .tab {
        padding: 10px 20px;
        cursor: pointer;
        border: none;
        background: none;
        border-bottom: 2px solid transparent;
        font-size: 16px;
      }
      .tab.active {
        border-bottom-color: #007bff;
        color: #007bff;
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      .activity {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        background: white;
      }
      .activity h3 {
        margin: 0 0 10px 0;
        color: #333;
      }
      .progress-bar {
        width: 100%;
        height: 20px;
        background-color: #e9ecef;
        border-radius: 10px;
        overflow: hidden;
        margin: 10px 0;
      }
      .progress-fill {
        height: 100%;
        background-color: #28a745;
        transition: width 0.3s ease;
      }
      .progress-text {
        text-align: center;
        margin-top: 5px;
        font-weight: bold;
      }
      .sub-activity {
        margin-left: 20px;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 5px;
        margin-bottom: 8px;
      }
      .statistics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }
      .stat-card {
        background: #007bff;
        color: white;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
      }
      .loading {
        text-align: center;
        padding: 20px;
        font-size: 18px;
      }
      .error {
        background-color: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 5px;
        margin: 10px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Visualização de Projeto - Teste</h1>

      <div class="statistics" id="statistics">
        <!-- Statistics will be loaded here -->
      </div>

      <div class="tabs">
        <button class="tab active" onclick="switchTab('procedimento-parada')">
          Procedimento de Parada
        </button>
        <button class="tab" onclick="switchTab('manutencao')">
          Manutenção
        </button>
        <button class="tab" onclick="switchTab('procedimento-partida')">
          Procedimento de Partida
        </button>
      </div>

      <div id="procedimento-parada" class="tab-content active">
        <div class="loading">Carregando procedimento de parada...</div>
      </div>

      <div id="manutencao" class="tab-content">
        <div class="loading">Carregando manutenção...</div>
      </div>

      <div id="procedimento-partida" class="tab-content">
        <div class="loading">Carregando procedimento de partida...</div>
      </div>
    </div>

    <script>
      const API_BASE = 'http://localhost:6000';
      const PROJECT_ID = '123'; // ID de teste

      let currentTab = 'procedimento-parada';

      function switchTab(tabName) {
        // Update tab buttons
        document.querySelectorAll('.tab').forEach((tab) => {
          tab.classList.remove('active');
        });
        event.target.classList.add('active');

        // Update tab content
        document.querySelectorAll('.tab-content').forEach((content) => {
          content.classList.remove('active');
        });
        document.getElementById(tabName).classList.add('active');

        currentTab = tabName;
        loadTabData(tabName);
      }

      function createProgressBar(planned, real) {
        const percentage =
          planned > 0 ? Math.min((real / planned) * 100, 100) : 0;
        return `
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${percentage}%"></div>
                </div>
                <div class="progress-text">${real.toFixed(1)}% / ${planned.toFixed(1)}% (${percentage.toFixed(1)}%)</div>
            `;
      }

      function renderActivities(activities, containerId) {
        const container = document.getElementById(containerId);

        if (!activities || activities.length === 0) {
          container.innerHTML =
            '<div class="error">Nenhuma atividade encontrada</div>';
          return;
        }

        const html = activities
          .map(
            (activity) => `
                <div class="activity">
                    <h3>${activity.name}</h3>
                    ${createProgressBar(activity.planned, activity.real)}
                    ${
                      activity.sub_activities
                        ? activity.sub_activities
                            .map(
                              (sub) => `
                        <div class="sub-activity">
                            <strong>${sub.name}</strong>
                            ${createProgressBar(sub.planned, sub.real)}
                        </div>
                    `
                            )
                            .join('')
                        : ''
                    }
                </div>
            `
          )
          .join('');

        container.innerHTML = html;
      }

      function renderStatistics(stats) {
        const container = document.getElementById('statistics');

        if (!stats || !stats.data) {
          container.innerHTML =
            '<div class="error">Estatísticas não disponíveis</div>';
          return;
        }

        const geral = stats.data.geral;
        const html = `
                <div class="stat-card">
                    <h3>Total de Atividades</h3>
                    <p style="font-size: 24px; margin: 5px 0;">${geral.totalAtividades}</p>
                </div>
                <div class="stat-card">
                    <h3>Progresso Médio Real</h3>
                    <p style="font-size: 24px; margin: 5px 0;">${geral.progressoMedioReal.toFixed(1)}%</p>
                </div>
                <div class="stat-card">
                    <h3>Progresso Médio Planejado</h3>
                    <p style="font-size: 24px; margin: 5px 0;">${geral.progressoMedioPlanejado.toFixed(1)}%</p>
                </div>
                <div class="stat-card">
                    <h3>Eficiência</h3>
                    <p style="font-size: 24px; margin: 5px 0;">${geral.eficiencia.toFixed(1)}%</p>
                </div>
            `;

        container.innerHTML = html;
      }

      async function loadTabData(tabName) {
        try {
          const response = await fetch(
            `${API_BASE}/api/projects/${PROJECT_ID}/${tabName}`
          );
          const data = await response.json();
          renderActivities(data, tabName);
        } catch (error) {
          console.error('Erro ao carregar dados:', error);
          document.getElementById(tabName).innerHTML =
            `<div class="error">Erro ao carregar dados: ${error.message}</div>`;
        }
      }

      async function loadStatistics() {
        try {
          const response = await fetch(
            `${API_BASE}/api/projects/${PROJECT_ID}/statistics`
          );
          const data = await response.json();
          renderStatistics(data);
        } catch (error) {
          console.error('Erro ao carregar estatísticas:', error);
          document.getElementById('statistics').innerHTML =
            `<div class="error">Erro ao carregar estatísticas: ${error.message}</div>`;
        }
      }

      // Load initial data
      window.addEventListener('load', () => {
        loadStatistics();
        loadTabData('procedimento-parada');
      });
    </script>
  </body>
</html>
