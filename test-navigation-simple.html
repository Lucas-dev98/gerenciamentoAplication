<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Teste Simples - NavegaÃ§Ã£o</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
        font-size: 16px;
      }
      .btn:hover {
        background: #0056b3;
      }
      .btn.success {
        background: #28a745;
      }
      .btn.warning {
        background: #ffc107;
        color: #000;
      }
      .btn.danger {
        background: #dc3545;
      }
      #log {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 15px;
        margin-top: 20px;
        font-family: monospace;
        font-size: 14px;
        white-space: pre-wrap;
        max-height: 400px;
        overflow-y: auto;
      }
      .step {
        background: #e9ecef;
        padding: 15px;
        border-radius: 5px;
        margin: 10px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ§ª Teste de NavegaÃ§Ã£o - EPU GestÃ£o</h1>

      <div class="step">
        <h3>Passo 1: Verificar Estado Atual</h3>
        <button class="btn" onclick="checkCurrentState()">
          ğŸ” Verificar Estado
        </button>
        <button class="btn warning" onclick="clearStorage()">
          ğŸ§¹ Limpar Storage
        </button>
      </div>

      <div class="step">
        <h3>Passo 2: Fazer Login</h3>
        <button class="btn success" onclick="doLogin()">ğŸ” Fazer Login</button>
        <button class="btn" onclick="checkToken()">ğŸŸï¸ Verificar Token</button>
      </div>

      <div class="step">
        <h3>Passo 3: Navegar para Projetos</h3>
        <button class="btn" onclick="navigateToProjects()">
          ğŸ“‹ Ir para Projetos
        </button>
        <button class="btn" onclick="openProjectsNewTab()">
          ğŸ“‹ Abrir em Nova Aba
        </button>
      </div>

      <div class="step">
        <h3>Passo 4: Debug Manual</h3>
        <button class="btn warning" onclick="injectDebugCode()">
          ğŸ”§ Injetar Debug
        </button>
        <button class="btn danger" onclick="clearLog()">ğŸ—‘ï¸ Limpar Log</button>
      </div>

      <div id="log">Aguardando aÃ§Ãµes...</div>
    </div>

    <script>
      const log = document.getElementById('log');

      function logMessage(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const emoji =
          type === 'error'
            ? 'âŒ'
            : type === 'success'
              ? 'âœ…'
              : type === 'warning'
                ? 'âš ï¸'
                : 'â„¹ï¸';
        log.textContent += `[${timestamp}] ${emoji} ${message}\n`;
        log.scrollTop = log.scrollHeight;
        console.log(`[${type.toUpperCase()}] ${message}`);
      }

      function clearLog() {
        log.textContent = 'Log limpo...\n';
      }

      function checkCurrentState() {
        logMessage('ğŸ” Verificando estado atual...');

        // URL atual
        logMessage(`ğŸ“ URL atual: ${window.location.href}`);

        // Local storage
        const token = localStorage.getItem('token');
        logMessage(
          `ğŸŸï¸ Token no localStorage: ${token ? 'Presente' : 'Ausente'}`
        );

        if (token) {
          try {
            const decoded = JSON.parse(atob(token.split('.')[1]));
            logMessage(
              `ğŸ• Token expira em: ${new Date(decoded.exp * 1000).toLocaleString()}`
            );
          } catch (e) {
            logMessage('âš ï¸ Erro ao decodificar token', 'warning');
          }
        }

        // Session storage
        const sessionToken = sessionStorage.getItem('token');
        logMessage(
          `ğŸŸï¸ Token no sessionStorage: ${sessionToken ? 'Presente' : 'Ausente'}`
        );

        // Verificar se hÃ¡ erros no console
        logMessage(
          'ğŸ“ Verifique o console do navegador (F12) para erros JavaScript'
        );
      }

      function clearStorage() {
        localStorage.clear();
        sessionStorage.clear();
        logMessage('ğŸ§¹ Storage limpo', 'success');
      }

      async function doLogin() {
        logMessage('ğŸ” Tentando fazer login...');

        try {
          const response = await fetch('http://localhost:5000/api/auth/login', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              email: 'admin@epugestao.com',
              password: 'admin123',
            }),
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();
          const token = data.data?.token || data.token;

          if (token) {
            localStorage.setItem('token', token);
            logMessage('âœ… Login bem-sucedido! Token salvo.', 'success');
            logMessage(`ğŸŸï¸ Token: ${token.substring(0, 30)}...`);
          } else {
            logMessage('âŒ Token nÃ£o recebido na resposta', 'error');
          }
        } catch (error) {
          logMessage(`âŒ Erro no login: ${error.message}`, 'error');
        }
      }

      function checkToken() {
        const token = localStorage.getItem('token');
        if (token) {
          logMessage('âœ… Token encontrado no localStorage', 'success');
          logMessage(`ğŸŸï¸ Token: ${token.substring(0, 50)}...`);

          // Testar token com API
          fetch('http://localhost:5000/api/projects', {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          })
            .then((response) => {
              if (response.ok) {
                logMessage(
                  'âœ… Token vÃ¡lido - API respondeu com sucesso',
                  'success'
                );
              } else {
                logMessage(
                  `âŒ Token invÃ¡lido - API retornou ${response.status}`,
                  'error'
                );
              }
            })
            .catch((error) => {
              logMessage(`âŒ Erro ao testar token: ${error.message}`, 'error');
            });
        } else {
          logMessage('âŒ Nenhum token encontrado', 'error');
        }
      }

      function navigateToProjects() {
        logMessage('ğŸ“‹ Navegando para /projetos...');
        window.location.href = 'http://localhost:3000/projetos';
      }

      function openProjectsNewTab() {
        logMessage('ğŸ“‹ Abrindo /projetos em nova aba...');
        window.open('http://localhost:3000/projetos', '_blank');
      }

      function injectDebugCode() {
        logMessage('ğŸ”§ CÃ³digo de debug copiado para o clipboard!', 'success');
        logMessage('ğŸ“ Cole este cÃ³digo no console da pÃ¡gina de projetos:');

        const debugCode = `
console.log('ğŸ” Debug iniciado');

// Verificar se React estÃ¡ carregado
if (window.React) {
    console.log('âœ… React detectado');
} else {
    console.log('âŒ React nÃ£o detectado');
}

// Procurar componentes React
const reactRoot = document.querySelector('#root');
if (reactRoot) {
    console.log('âœ… Root React encontrado');
    console.log('ğŸ¯ ConteÃºdo do root:', reactRoot.innerHTML.substring(0, 200));
} else {
    console.log('âŒ Root React nÃ£o encontrado');
}

// Procurar elementos de projeto
const projectElements = document.querySelectorAll('[class*="project"], [class*="Project"], [data-testid*="project"]');
console.log('ğŸ“‹ Elementos de projeto encontrados:', projectElements.length);

projectElements.forEach((el, index) => {
    console.log(\`\${index + 1}. \${el.tagName} - \${el.className}\`);
});

// Verificar erros
console.log('ğŸ“ Verifique a aba Network para requisiÃ§Ãµes falhadas');
console.log('ğŸ“ Verifique a aba Console para erros JavaScript');
            `;

        navigator.clipboard
          .writeText(debugCode)
          .then(() => {
            logMessage(
              'ğŸ“‹ CÃ³digo copiado! Cole no console da pÃ¡gina de projetos.',
              'success'
            );
          })
          .catch(() => {
            logMessage('âŒ Erro ao copiar. CÃ³digo mostrado abaixo:', 'error');
            logMessage(debugCode);
          });
      }

      // Auto-start
      window.onload = () => {
        logMessage('ğŸš€ Teste de navegaÃ§Ã£o iniciado');
        logMessage('ğŸ“ Siga os passos numerados acima');
        checkCurrentState();
      };
    </script>
  </body>
</html>
