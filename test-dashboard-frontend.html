<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Teste Dashboard - EPU</title>
    <style>
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background-color: #f8fafc;
        margin: 0;
        padding: 20px;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
      }
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }
      .stat-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        border-left: 4px solid #3b82f6;
      }
      .stat-card h3 {
        margin: 0 0 10px 0;
        color: #374151;
        font-size: 14px;
        font-weight: 500;
      }
      .stat-card .value {
        font-size: 32px;
        font-weight: 700;
        color: #111827;
        margin-bottom: 5px;
      }
      .stat-card .icon {
        font-size: 24px;
        margin-bottom: 10px;
      }
      .test-info {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        border-left: 4px solid #10b981;
      }
      .error {
        background: #fef2f2;
        border-left: 4px solid #ef4444;
        color: #dc2626;
      }
      .success {
        background: #f0fdf4;
        border-left: 4px solid #10b981;
        color: #059669;
      }
      .loading {
        background: #fef3c7;
        border-left: 4px solid #f59e0b;
        color: #d97706;
      }
      button {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        margin-right: 10px;
      }
      button:hover {
        background: #2563eb;
      }
      #console {
        background: #1f2937;
        color: #f9fafb;
        padding: 20px;
        border-radius: 8px;
        font-family: 'Courier New', monospace;
        font-size: 13px;
        max-height: 400px;
        overflow-y: auto;
        white-space: pre-wrap;
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üéØ Teste Dashboard - EPU Gest√£o</h1>

      <div class="test-info">
        <h3>Status do Teste</h3>
        <p id="status">Aguardando in√≠cio do teste...</p>
        <button onclick="testDashboard()">Testar Dashboard</button>
        <button onclick="testLogin()">Testar Login</button>
        <button onclick="clearConsole()">Limpar Console</button>
      </div>

      <div class="stats-grid" id="statsGrid">
        <!-- Stats ser√£o inseridos aqui -->
      </div>

      <div id="console"></div>
    </div>

    <script>
      const API_URL = 'http://localhost:5000';
      let authToken = null;

      function log(message) {
        const console = document.getElementById('console');
        const timestamp = new Date().toLocaleTimeString();
        console.textContent += `[${timestamp}] ${message}\n`;
        console.scrollTop = console.scrollHeight;
      }

      function clearConsole() {
        document.getElementById('console').textContent = '';
      }

      function updateStatus(message, type = 'info') {
        const statusEl = document.getElementById('status');
        statusEl.textContent = message;
        statusEl.className = type;
      }

      async function testLogin() {
        try {
          updateStatus('Fazendo login...', 'loading');
          log('üîë Tentando fazer login...');

          const response = await fetch(`${API_URL}/api/auth/login`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              email: 'teste@teste.com',
              password: 'teste123',
            }),
          });

          if (!response.ok) {
            throw new Error(`Erro no login: ${response.status}`);
          }

          const data = await response.json();
          authToken = data.token;

          log(`‚úÖ Login realizado com sucesso!`);
          log(`Token: ${authToken.substring(0, 20)}...`);
          updateStatus('Login realizado com sucesso!', 'success');
        } catch (error) {
          log(`‚ùå Erro no login: ${error.message}`);
          updateStatus(`Erro no login: ${error.message}`, 'error');
        }
      }

      async function testDashboard() {
        if (!authToken) {
          updateStatus('Token n√£o encontrado! Fa√ßa login primeiro.', 'error');
          return;
        }

        try {
          updateStatus('Testando dashboard...', 'loading');
          log('üéØ Iniciando teste do dashboard...');

          const headers = {
            Authorization: `Bearer ${authToken}`,
            'Content-Type': 'application/json',
          };

          // Buscar projetos
          log('üìä Buscando projetos...');
          const projectsResponse = await fetch(`${API_URL}/api/projects-crud`, {
            headers,
          });

          if (!projectsResponse.ok) {
            throw new Error(
              `Erro ao buscar projetos: ${projectsResponse.status}`
            );
          }

          const projectsData = await projectsResponse.json();
          const projects = projectsData?.data?.data || [];
          log(`üìä Projetos encontrados: ${projects.length}`);

          // Buscar estat√≠sticas
          log('üìà Buscando estat√≠sticas...');
          const statsResponse = await fetch(
            `${API_URL}/api/projects-crud/stats`,
            { headers }
          );

          if (!statsResponse.ok) {
            throw new Error(
              `Erro ao buscar estat√≠sticas: ${statsResponse.status}`
            );
          }

          const statsData = await statsResponse.json();
          const projectStats = statsData?.data || {};
          log(`üìà Estat√≠sticas: ${JSON.stringify(projectStats, null, 2)}`);

          // Buscar outros dados
          const endpoints = [
            { name: 'Equipes', url: '/api/teams', key: 'teams' },
            { name: 'Membros', url: '/api/members', key: 'members' },
            { name: 'Eventos', url: '/api/events', key: 'events' },
            { name: 'Avisos', url: '/api/notices', key: 'notices' },
          ];

          const additionalData = {};

          for (const endpoint of endpoints) {
            try {
              log(`üîç Buscando ${endpoint.name}...`);
              const response = await fetch(`${API_URL}${endpoint.url}`, {
                headers,
              });

              if (response.ok) {
                const data = await response.json();
                additionalData[endpoint.key] = data?.data || [];
                log(
                  `‚úÖ ${endpoint.name}: ${additionalData[endpoint.key].length || 0} encontrados`
                );
              } else {
                log(
                  `‚ö†Ô∏è ${endpoint.name}: Endpoint n√£o dispon√≠vel (${response.status})`
                );
                additionalData[endpoint.key] = [];
              }
            } catch (error) {
              log(`‚ùå Erro ao buscar ${endpoint.name}: ${error.message}`);
              additionalData[endpoint.key] = [];
            }
          }

          // Calcular estat√≠sticas do dashboard
          const dashboardStats = {
            totalProjects: projectStats.totalProjects || projects.length,
            activeProjects:
              projectStats.activeProjects ||
              projects.filter(
                (p) => p.status === 'active' || p.status === 'em_andamento'
              ).length,
            completedProjects:
              projectStats.completedProjects ||
              projects.filter(
                (p) => p.status === 'completed' || p.status === 'concluido'
              ).length,
            totalNotices: additionalData.notices.length || 0,
            unreadNotices:
              additionalData.notices.filter((n) => !n.read).length || 0,
            totalEvents: additionalData.events.length || 0,
            upcomingEvents: 0, // Simplificado para o teste
            totalTeams: additionalData.teams.length || 0,
            totalMembers: additionalData.members.length || 0,
            birthdaysThisMonth: 0,
          };

          log(`üéØ ESTAT√çSTICAS CALCULADAS:`);
          log(JSON.stringify(dashboardStats, null, 2));

          // Mostrar estat√≠sticas na tela
          displayStats(dashboardStats);

          updateStatus('Dashboard testado com sucesso!', 'success');
        } catch (error) {
          log(`‚ùå Erro no teste do dashboard: ${error.message}`);
          updateStatus(`Erro no teste: ${error.message}`, 'error');
        }
      }

      function displayStats(stats) {
        const statsGrid = document.getElementById('statsGrid');

        const cards = [
          {
            title: 'Total de Projetos',
            value: stats.totalProjects,
            icon: 'üìä',
            color: '#3b82f6',
          },
          {
            title: 'Projetos Ativos',
            value: stats.activeProjects,
            icon: 'üéØ',
            color: '#10b981',
          },
          {
            title: 'Projetos Completos',
            value: stats.completedProjects,
            icon: '‚úÖ',
            color: '#6366f1',
          },
          {
            title: 'Total de Avisos',
            value: stats.totalNotices,
            icon: 'üì¢',
            color: '#f59e0b',
          },
          {
            title: 'Avisos N√£o Lidos',
            value: stats.unreadNotices,
            icon: 'üîî',
            color: '#ef4444',
          },
          {
            title: 'Total de Eventos',
            value: stats.totalEvents,
            icon: 'üìÖ',
            color: '#8b5cf6',
          },
          {
            title: 'Eventos Pr√≥ximos',
            value: stats.upcomingEvents,
            icon: '‚è∞',
            color: '#06b6d4',
          },
          {
            title: 'Total de Equipes',
            value: stats.totalTeams,
            icon: 'üë•',
            color: '#84cc16',
          },
          {
            title: 'Total de Membros',
            value: stats.totalMembers,
            icon: 'üßë‚Äçüíº',
            color: '#f97316',
          },
          {
            title: 'Anivers√°rios Este M√™s',
            value: stats.birthdaysThisMonth,
            icon: 'üéÇ',
            color: '#ec4899',
          },
        ];

        statsGrid.innerHTML = cards
          .map(
            (card) => `
                <div class="stat-card" style="border-left-color: ${card.color}">
                    <div class="icon">${card.icon}</div>
                    <h3>${card.title}</h3>
                    <div class="value">${card.value}</div>
                </div>
            `
          )
          .join('');
      }

      // Fazer login autom√°tico quando a p√°gina carregar
      window.onload = function () {
        testLogin();
      };
    </script>
  </body>
</html>
