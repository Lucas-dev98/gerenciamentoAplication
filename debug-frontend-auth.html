<!doctype html>
<html>
  <head>
    <title>Debug Frontend Auth</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .test-box {
        padding: 20px;
        margin: 10px 0;
        border-radius: 8px;
      }
      .success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
      }
      .error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
      }
      .info {
        background: #d1ecf1;
        border: 1px solid #bee5eb;
      }
    </style>
  </head>
  <body>
    <h1>游댌 Debug Frontend Auth</h1>

    <div id="results"></div>

    <script>
      const API_URL = 'http://localhost:5000';
      const resultsDiv = document.getElementById('results');

      function addResult(type, title, message) {
        const div = document.createElement('div');
        div.className = `test-box ${type}`;
        div.innerHTML = `<h3>${title}</h3><pre>${message}</pre>`;
        resultsDiv.appendChild(div);
      }

      async function testAuth() {
        try {
          addResult('info', '1. Testando Login', 'Tentando fazer login...');

          const loginResponse = await fetch(`${API_URL}/api/auth/login`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              email: 'teste@teste.com',
              password: 'teste123',
            }),
          });

          if (!loginResponse.ok) {
            throw new Error(`Login failed: ${loginResponse.status}`);
          }

          const loginData = await loginResponse.json();
          const token = loginData.token;

          addResult(
            'success',
            '2. Login Sucesso',
            `Token: ${token.substring(0, 30)}...`
          );

          // Simular o que o frontend faz - salvar no localStorage
          localStorage.setItem('token', token);
          localStorage.setItem('user', JSON.stringify(loginData.user));

          addResult('success', '3. Token Salvo', 'Token salvo no localStorage');

          // Testar as chamadas que o useDashboard faz
          const headers = {
            Authorization: `Bearer ${token}`,
            'Content-Type': 'application/json',
          };

          // Teste 1: Projects
          const projectsResponse = await fetch(`${API_URL}/api/projects-crud`, {
            headers,
          });
          const projectsData = await projectsResponse.json();

          addResult(
            'success',
            '4. Projects API',
            `Projetos: ${projectsData?.data?.data?.length || 0}`
          );

          // Teste 2: Stats
          const statsResponse = await fetch(
            `${API_URL}/api/projects-crud/stats`,
            { headers }
          );
          const statsData = await statsResponse.json();

          addResult(
            'success',
            '5. Stats API',
            `Stats: ${JSON.stringify(statsData?.data, null, 2)}`
          );

          // Teste 3: Simular o que o componente DashboardStats deveria receber
          const finalStats = {
            totalProjects: statsData?.data?.totalProjects || 0,
            activeProjects: statsData?.data?.activeProjects || 0,
            completedProjects: statsData?.data?.completedProjects || 0,
            totalNotices: 0,
            unreadNotices: 0,
            totalEvents: 0,
            upcomingEvents: 0,
            totalTeams: 0,
            totalMembers: 0,
            birthdaysThisMonth: 0,
          };

          addResult(
            'success',
            '6. Stats Calculadas',
            `Dashboard Stats: ${JSON.stringify(finalStats, null, 2)}`
          );

          // Teste 4: Verificar se o usu치rio est치 logado
          const storedToken = localStorage.getItem('token');
          const storedUser = localStorage.getItem('user');

          addResult(
            'info',
            '7. LocalStorage Check',
            `Token: ${storedToken ? 'EXISTS' : 'MISSING'}\nUser: ${storedUser ? 'EXISTS' : 'MISSING'}`
          );

          if (finalStats.totalProjects > 0) {
            addResult(
              'success',
              '8. CONCLUS츾O',
              'API est치 funcionando! O problema est치 no React ou na autentica칞칚o do contexto.'
            );
          } else {
            addResult('error', '8. CONCLUS츾O', 'Os dados ainda est칚o zerados.');
          }
        } catch (error) {
          addResult('error', 'ERRO', error.message);
        }
      }

      // Executar teste
      testAuth();
    </script>
  </body>
</html>
