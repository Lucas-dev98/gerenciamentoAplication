<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Teste Navega√ß√£o - Reproduzir Problema</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: #f5f5f5;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .step {
        margin-bottom: 20px;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      .success {
        background: #d4edda;
        border-color: #c3e6cb;
      }
      .error {
        background: #f8d7da;
        border-color: #f5c6cb;
      }
      .warning {
        background: #fff3cd;
        border-color: #ffeaa7;
      }
      .info {
        background: #d1ecf1;
        border-color: #bee5eb;
      }
      button {
        padding: 10px 15px;
        margin: 5px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        background: #007bff;
        color: white;
        font-size: 14px;
      }
      button:hover {
        background: #0056b3;
      }
      .highlight {
        background: #ffc107;
        color: #000;
      }
      .data {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 3px;
        margin-top: 10px;
        font-family: monospace;
        white-space: pre-wrap;
        font-size: 12px;
      }
      .currentUrl {
        background: #e9ecef;
        padding: 5px 10px;
        border-radius: 3px;
        font-family: monospace;
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîç Teste: Reproduzindo Problema de Navega√ß√£o</h1>
      <p>
        <strong>Objetivo:</strong> Reproduzir exatamente o problema onde clicar
        em "üìã Ir para Projetos" leva √† p√°gina inicial em vez de /projetos
      </p>

      <div class="currentUrl">
        <strong>URL Atual:</strong> <span id="currentUrl">-</span>
      </div>

      <div class="step info">
        <h3>ETAPA 1: Estado Inicial</h3>
        <p>Verificar se estamos na p√°gina correta e sem autentica√ß√£o</p>
        <button onclick="checkInitialState()">Verificar Estado Inicial</button>
        <div id="step1Result" class="data">Clique no bot√£o acima</div>
      </div>

      <div class="step info">
        <h3>ETAPA 2: Fazer Login</h3>
        <p>Login com credenciais v√°lidas: teste@teste.com / teste123</p>
        <button onclick="performLogin()">üîê Fazer Login</button>
        <div id="step2Result" class="data">Clique no bot√£o acima</div>
      </div>

      <div class="step warning">
        <h3>ETAPA 3: Verificar Estado ap√≥s Login</h3>
        <p>Confirmar que token e user est√£o no localStorage</p>
        <button onclick="checkLoginState()">Verificar Estado do Login</button>
        <div id="step3Result" class="data">Clique no bot√£o acima</div>
      </div>

      <div class="step highlight">
        <h3>üéØ ETAPA 4: REPRODUZIR O PROBLEMA</h3>
        <p><strong>Esta √© a etapa onde acontece o problema!</strong></p>
        <p>Clique em "üìã Ir para Projetos" para tentar navegar diretamente</p>
        <button onclick="navigateToProjects()">üìã Ir para Projetos</button>
        <div id="step4Result" class="data">
          üëÜ ESTE √â O BOT√ÉO QUE CAUSA O PROBLEMA
        </div>
      </div>

      <div class="step error">
        <h3>ETAPA 5: Analisar o Resultado</h3>
        <p>Verificar para onde fomos redirecionados</p>
        <button onclick="analyzeRedirection()">
          üîç Analisar Redirecionamento
        </button>
        <div id="step5Result" class="data">
          Clique no bot√£o acima ap√≥s tentar navegar
        </div>
      </div>

      <div class="step info">
        <h3>üîß DEBUG: Console Logs</h3>
        <p>Logs detalhados para debug</p>
        <button onclick="showConsoleLogs()">üìã Mostrar Logs</button>
        <div id="debugLogs" class="data"></div>
      </div>

      <div class="step success">
        <h3>‚úÖ SOLU√á√ÉO: Testar Navega√ß√£o Program√°tica</h3>
        <p>Testar se o problema √© no bot√£o ou na l√≥gica de roteamento</p>
        <button onclick="testProgrammaticNavigation()">
          üß™ Teste Program√°tico
        </button>
        <div id="solutionResult" class="data">
          Teste alternativo de navega√ß√£o
        </div>
      </div>
    </div>

    <script>
      let logs = [];

      function addLog(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = `[${timestamp}] ${message}`;
        logs.push(logEntry);
        console.log(logEntry);
      }

      function updateCurrentUrl() {
        document.getElementById('currentUrl').textContent =
          window.location.href;
      }

      function checkInitialState() {
        addLog('üîç Verificando estado inicial...');

        const token = localStorage.getItem('token');
        const user = localStorage.getItem('user');

        const state = {
          currentUrl: window.location.href,
          hasToken: !!token,
          hasUser: !!user,
          isOnHomepage:
            window.location.pathname === '/' || window.location.pathname === '',
          localStorage: {
            tokenLength: token ? token.length : 0,
            userPresent: !!user,
          },
        };

        document.getElementById('step1Result').textContent = JSON.stringify(
          state,
          null,
          2
        );

        if (state.hasToken && state.hasUser) {
          addLog('‚ö†Ô∏è ATEN√á√ÉO: Token e user j√° existem no localStorage');
        } else {
          addLog('‚úÖ Estado inicial limpo - sem autentica√ß√£o');
        }
      }

      async function performLogin() {
        addLog('üîê Iniciando processo de login...');

        try {
          const response = await fetch('http://localhost:3001/api/auth/login', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              email: 'teste@teste.com',
              password: 'teste123',
            }),
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();

          if (data.token && data.user) {
            // Simular o que o AuthContext faria
            localStorage.setItem('token', data.token);
            localStorage.setItem('user', JSON.stringify(data.user));

            addLog('‚úÖ Login realizado com sucesso');
            addLog('üíæ Token e user salvos no localStorage');

            const result = {
              success: true,
              token: data.token.substring(0, 30) + '...',
              user: data.user.email,
              tokenSaved: !!localStorage.getItem('token'),
              userSaved: !!localStorage.getItem('user'),
            };

            document.getElementById('step2Result').textContent = JSON.stringify(
              result,
              null,
              2
            );
          } else {
            throw new Error('Resposta de login inv√°lida');
          }
        } catch (error) {
          addLog('‚ùå Erro no login: ' + error.message);
          document.getElementById('step2Result').textContent =
            'ERRO: ' + error.message;
        }
      }

      function checkLoginState() {
        addLog('üîç Verificando estado ap√≥s login...');

        const token = localStorage.getItem('token');
        const user = localStorage.getItem('user');

        let parsedUser = null;
        if (user) {
          try {
            parsedUser = JSON.parse(user);
          } catch (e) {
            addLog('‚ùå Erro ao parsear user data');
          }
        }

        const state = {
          authentication: {
            hasToken: !!token,
            hasUser: !!user,
            tokenValid: token && token.length > 50,
            userValid: parsedUser && parsedUser.email,
          },
          authContextSimulation: {
            wouldRestoreSession: !!(token && user),
            wouldSetAuthenticated: !!(token && parsedUser),
            isAuthenticated: !!(token && parsedUser),
          },
          protectedRouteSimulation: {
            isLoading: false, // Assumindo que n√£o est√° carregando
            isAuthenticated: !!(token && parsedUser),
            wouldAllowAccess: !!(token && parsedUser),
            wouldRedirect: !(token && parsedUser),
          },
        };

        document.getElementById('step3Result').textContent = JSON.stringify(
          state,
          null,
          2
        );

        if (state.authContextSimulation.isAuthenticated) {
          addLog('‚úÖ Simula√ß√£o: AuthContext deveria marcar como autenticado');
        } else {
          addLog('‚ùå Simula√ß√£o: AuthContext N√ÉO marcaria como autenticado');
        }
      }

      function navigateToProjects() {
        addLog('üéØ REPRODUZINDO O PROBLEMA: Tentando navegar para /projetos');

        // Simular exatamente o que acontece quando clicamos no bot√£o
        const currentUrl = window.location.href;
        addLog('üìç URL antes da navega√ß√£o: ' + currentUrl);

        // Verificar estado de autentica√ß√£o antes da navega√ß√£o
        const token = localStorage.getItem('token');
        const user = localStorage.getItem('user');

        const authState = {
          beforeNavigation: {
            hasToken: !!token,
            hasUser: !!user,
            currentPath: window.location.pathname,
          },
        };

        // ESTE √â O MOMENTO CR√çTICO - vamos tentar navegar
        addLog('üöÄ Executando navega√ß√£o...');

        try {
          // Simular o que o React Router faria
          if (window.location.pathname !== '/projetos') {
            // Em uma SPA real, isso seria interceptado pelo ProtectedRoute
            addLog(
              '‚ö†Ô∏è Em uma SPA React, a navega√ß√£o seria interceptada pelo ProtectedRoute'
            );
            addLog(
              'üîç ProtectedRoute verificaria: isAuthenticated = ' +
                !!(token && user)
            );

            if (!(token && user)) {
              addLog('‚ùå ProtectedRoute redirecionaria para /login');
              authState.wouldRedirect = true;
              authState.redirectReason = 'N√£o autenticado';
            } else {
              addLog('‚úÖ ProtectedRoute permitiria acesso a /projetos');
              authState.wouldRedirect = false;
            }
          } else {
            addLog('‚ÑπÔ∏è J√° estamos em /projetos');
          }

          // Como estamos em um HTML simples, vamos simular a tentativa
          window.history.pushState({}, '', '/projetos');
          updateCurrentUrl();

          authState.afterNavigation = {
            currentPath: window.location.pathname,
            urlChanged: true,
            simulation:
              'Em uma SPA real, seria redirecionado se n√£o autenticado',
          };
        } catch (error) {
          addLog('‚ùå Erro durante navega√ß√£o: ' + error.message);
          authState.error = error.message;
        }

        document.getElementById('step4Result').textContent = JSON.stringify(
          authState,
          null,
          2
        );
      }

      function analyzeRedirection() {
        addLog('üîç Analisando resultado da navega√ß√£o...');

        const currentPath = window.location.pathname;
        const token = localStorage.getItem('token');
        const user = localStorage.getItem('user');

        const analysis = {
          currentLocation: {
            fullUrl: window.location.href,
            pathname: currentPath,
            isProjectsPage: currentPath === '/projetos',
            isHomePage: currentPath === '/' || currentPath === '',
            isLoginPage: currentPath === '/login',
          },
          authenticationState: {
            hasToken: !!token,
            hasUser: !!user,
            sessionValid: !!(token && user),
          },
          problemAnalysis: {
            expectedBehavior: 'Deveria estar em /projetos se autenticado',
            actualBehavior: currentPath,
            problemExists: !!(token && user && currentPath !== '/projetos'),
            likelyReason:
              currentPath !== '/projetos'
                ? 'ProtectedRoute redirecionou ou navega√ß√£o falhou'
                : 'Funcionou corretamente',
          },
        };

        if (analysis.problemAnalysis.problemExists) {
          addLog(
            'üö® PROBLEMA CONFIRMADO: Temos token/user mas n√£o estamos em /projetos'
          );
          addLog('üîß Poss√≠veis causas:');
          addLog('   1. AuthContext n√£o restaurou sess√£o');
          addLog('   2. ProtectedRoute executou antes da restaura√ß√£o');
          addLog('   3. Timing problem no useEffect');
          addLog('   4. Navigate sempre redireciona');
        } else if (
          analysis.authenticationState.sessionValid &&
          analysis.currentLocation.isProjectsPage
        ) {
          addLog('‚úÖ FUNCIONOU: Autenticado e em /projetos');
        } else {
          addLog('‚ÑπÔ∏è Comportamento esperado: sem auth, n√£o vai para /projetos');
        }

        document.getElementById('step5Result').textContent = JSON.stringify(
          analysis,
          null,
          2
        );
      }

      function showConsoleLogs() {
        document.getElementById('debugLogs').textContent = logs.join('\n');
      }

      function testProgrammaticNavigation() {
        addLog('üß™ Testando navega√ß√£o program√°tica...');

        // Testar diferentes formas de navega√ß√£o
        const tests = [];

        // Teste 1: window.location
        try {
          tests.push({
            method: 'window.location.href',
            success: true,
            note: 'Funcionaria mas recarregaria a p√°gina',
          });
        } catch (e) {
          tests.push({
            method: 'window.location.href',
            success: false,
            error: e.message,
          });
        }

        // Teste 2: history.pushState
        try {
          window.history.pushState({}, '', '/projetos');
          tests.push({
            method: 'history.pushState',
            success: true,
            note: 'Muda URL mas n√£o executa React Router',
          });
        } catch (e) {
          tests.push({
            method: 'history.pushState',
            success: false,
            error: e.message,
          });
        }

        const result = {
          tests: tests,
          recommendation: 'Em React, use navigate() do react-router-dom',
          realWorldSolution:
            'Verificar se AuthContext.isAuthenticated est√° sendo setado corretamente',
        };

        document.getElementById('solutionResult').textContent = JSON.stringify(
          result,
          null,
          2
        );
        updateCurrentUrl();
      }

      // Inicializa√ß√£o
      window.onload = function () {
        updateCurrentUrl();
        addLog('üîÑ P√°gina de teste carregada');

        // Monitorar mudan√ßas de URL
        setInterval(updateCurrentUrl, 1000);
      };
    </script>
  </body>
</html>
