<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EPU-Gest√£o - CRUD Projects</title>
    <style>
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        padding: 30px;
      }

      h1 {
        color: #2c3e50;
        text-align: center;
        margin-bottom: 30px;
        font-size: 2.5em;
      }

      .section {
        margin-bottom: 40px;
        padding: 20px;
        border: 2px solid #ecf0f1;
        border-radius: 10px;
        background: #f8f9fa;
      }

      .section h2 {
        color: #34495e;
        margin-top: 0;
        border-bottom: 2px solid #3498db;
        padding-bottom: 10px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #2c3e50;
      }

      input,
      textarea,
      select {
        width: 100%;
        padding: 12px;
        border: 1px solid #bdc3c7;
        border-radius: 5px;
        font-size: 16px;
        box-sizing: border-box;
      }

      textarea {
        height: 100px;
        resize: vertical;
      }

      button {
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-right: 10px;
        margin-bottom: 10px;
        transition: all 0.3s ease;
      }

      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      button.danger {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
      }

      button.success {
        background: linear-gradient(135deg, #27ae60, #229954);
      }

      .projects-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .project-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        border-left: 5px solid #3498db;
      }

      .project-card h3 {
        color: #2c3e50;
        margin-top: 0;
      }

      .project-meta {
        color: #7f8c8d;
        font-size: 14px;
        margin-bottom: 10px;
      }

      .progress-bar {
        background: #ecf0f1;
        border-radius: 10px;
        height: 10px;
        margin: 10px 0;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #27ae60, #2ecc71);
        border-radius: 10px;
        transition: width 0.3s ease;
      }

      .status {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
        text-transform: uppercase;
      }

      .status.completed {
        background: #d5f4e6;
        color: #27ae60;
      }
      .status.in_progress {
        background: #fff3cd;
        color: #856404;
      }
      .status.not_started {
        background: #f8d7da;
        color: #721c24;
      }

      .response {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
        font-family: monospace;
        white-space: pre-wrap;
        max-height: 300px;
        overflow-y: auto;
      }

      .response.success {
        background: #d5f4e6;
        color: #27ae60;
        border: 1px solid #27ae60;
      }

      .response.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #dc3545;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .stat-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .stat-number {
        font-size: 2em;
        font-weight: bold;
        color: #3498db;
      }

      .stat-label {
        color: #7f8c8d;
        margin-top: 5px;
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üèóÔ∏è EPU-Gest√£o - CRUD Projects</h1>

      <!-- Estat√≠sticas -->
      <div class="section">
        <h2>üìä Estat√≠sticas dos Projetos</h2>
        <button onclick="loadStats()">Carregar Estat√≠sticas</button>
        <div id="stats-container" class="stats-grid"></div>
      </div>

      <!-- Criar Projeto -->
      <div class="section">
        <h2>‚ûï Criar Novo Projeto</h2>
        <div class="form-group">
          <label for="projectName">Nome do Projeto:</label>
          <input
            type="text"
            id="projectName"
            placeholder="Digite o nome do projeto"
          />
        </div>
        <div class="form-group">
          <label for="projectDescription">Descri√ß√£o:</label>
          <textarea
            id="projectDescription"
            placeholder="Digite a descri√ß√£o do projeto"
          ></textarea>
        </div>
        <div class="form-group">
          <label for="projectType">Tipo:</label>
          <select id="projectType">
            <option value="epu">EPU</option>
            <option value="maintenance">Manuten√ß√£o</option>
            <option value="improvement">Melhoria</option>
          </select>
        </div>
        <div class="form-group">
          <label for="projectPriority">Prioridade:</label>
          <select id="projectPriority">
            <option value="low">Baixa</option>
            <option value="medium">M√©dia</option>
            <option value="high">Alta</option>
          </select>
        </div>
        <button onclick="createProject()" class="success">Criar Projeto</button>
      </div>

      <!-- Importar CSV -->
      <div class="section">
        <h2>üìÇ Importar Projeto via CSV</h2>
        <div class="form-group">
          <label for="csvFile">Arquivo CSV:</label>
          <input type="file" id="csvFile" accept=".csv" />
        </div>
        <div class="form-group">
          <label for="csvProjectName">Nome do Projeto:</label>
          <input
            type="text"
            id="csvProjectName"
            placeholder="Nome para o projeto importado"
          />
        </div>
        <div class="form-group">
          <label for="csvProjectDescription">Descri√ß√£o:</label>
          <textarea
            id="csvProjectDescription"
            placeholder="Descri√ß√£o do projeto importado"
          ></textarea>
        </div>
        <button onclick="importCsv()" class="success">Importar CSV</button>
      </div>

      <!-- Lista de Projetos -->
      <div class="section">
        <h2>üìã Lista de Projetos</h2>
        <button onclick="loadProjects()">Carregar Projetos</button>
        <button onclick="exportProject()" class="success">
          Exportar Selecionado
        </button>
        <button onclick="duplicateProject()" class="success">
          Duplicar Selecionado
        </button>
        <button onclick="deleteProject()" class="danger">
          Excluir Selecionado
        </button>
        <div id="projects-container" class="projects-list"></div>
      </div>

      <!-- Response Area -->
      <div id="response-area"></div>
    </div>

    <script>
      const API_BASE = 'http://localhost:5000/api/projects-crud';
      let selectedProjectId = null;

      // Fun√ß√£o para mostrar resposta
      function showResponse(data, isError = false) {
        const responseArea = document.getElementById('response-area');
        responseArea.innerHTML = `
                <div class="response ${isError ? 'error' : 'success'}">
                    ${JSON.stringify(data, null, 2)}
                </div>
            `;
      }

      // Fun√ß√£o para mostrar loading
      function showLoading(elementId) {
        document.getElementById(elementId).innerHTML =
          '<div class="loading"></div>';
      }

      // Carregar estat√≠sticas
      async function loadStats() {
        showLoading('stats-container');
        try {
          const response = await fetch(`${API_BASE}/stats`);
          const data = await response.json();

          if (data.success) {
            const stats = data.data;
            document.getElementById('stats-container').innerHTML = `
                        <div class="stat-card">
                            <div class="stat-number">${stats.total}</div>
                            <div class="stat-label">Total de Projetos</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${stats.completed}</div>
                            <div class="stat-label">Conclu√≠dos</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${stats.inProgress}</div>
                            <div class="stat-label">Em Progresso</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${stats.notStarted}</div>
                            <div class="stat-label">N√£o Iniciados</div>
                        </div>
                    `;
          }
          showResponse(data);
        } catch (error) {
          showResponse({ error: error.message }, true);
        }
      }

      // Criar projeto
      async function createProject() {
        const projectData = {
          name: document.getElementById('projectName').value,
          description: document.getElementById('projectDescription').value,
          type: document.getElementById('projectType').value,
          priority: document.getElementById('projectPriority').value,
          status: 'not_started',
          startDate: new Date().toISOString(),
          endDate: new Date(
            Date.now() + 90 * 24 * 60 * 60 * 1000
          ).toISOString(),
          assignedTo: 'Equipe EPU',
          tags: ['manual-creation'],
        };

        try {
          const response = await fetch(`${API_BASE}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(projectData),
          });
          const data = await response.json();
          showResponse(data);

          if (data.success) {
            // Limpar formul√°rio
            document.getElementById('projectName').value = '';
            document.getElementById('projectDescription').value = '';
            loadProjects(); // Recarregar lista
          }
        } catch (error) {
          showResponse({ error: error.message }, true);
        }
      }

      // Importar CSV
      async function importCsv() {
        const fileInput = document.getElementById('csvFile');
        const file = fileInput.files[0];

        if (!file) {
          showResponse({ error: 'Selecione um arquivo CSV' }, true);
          return;
        }

        const formData = new FormData();
        formData.append('csvFile', file);
        formData.append(
          'name',
          document.getElementById('csvProjectName').value || 'Projeto Importado'
        );
        formData.append(
          'description',
          document.getElementById('csvProjectDescription').value ||
            'Projeto criado via importa√ß√£o CSV'
        );
        formData.append('type', 'epu');
        formData.append('priority', 'medium');

        try {
          const response = await fetch(`${API_BASE}/import-csv`, {
            method: 'POST',
            body: formData,
          });
          const data = await response.json();
          showResponse(data);

          if (data.success) {
            // Limpar formul√°rio
            document.getElementById('csvFile').value = '';
            document.getElementById('csvProjectName').value = '';
            document.getElementById('csvProjectDescription').value = '';
            loadProjects(); // Recarregar lista
          }
        } catch (error) {
          showResponse({ error: error.message }, true);
        }
      }

      // Carregar projetos
      async function loadProjects() {
        showLoading('projects-container');
        try {
          const response = await fetch(`${API_BASE}`);
          const data = await response.json();

          if (data.success && data.data.length > 0) {
            const projectsHtml = data.data
              .map(
                (project) => `
                        <div class="project-card ${selectedProjectId === project._id ? 'selected' : ''}" 
                             onclick="selectProject('${project._id}')" 
                             style="${selectedProjectId === project._id ? 'border-left-color: #e74c3c; background: #fff5f5;' : ''}">
                            <h3>${project.name}</h3>
                            <div class="project-meta">
                                ID: ${project._id}<br>
                                Tipo: ${project.type}<br>
                                Criado: ${new Date(project.createdAt || project.startDate).toLocaleDateString()}
                            </div>
                            <p>${project.description}</p>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${project.progress || 0}%"></div>
                            </div>
                            <div>Progresso: ${project.progress || 0}%</div>
                            <span class="status ${project.status || 'not_started'}">${project.status || 'not_started'}</span>
                            <div style="margin-top: 10px;">
                                <strong>Atividades:</strong><br>
                                Parada: ${project.procedimentoParada?.length || 0}<br>
                                Manuten√ß√£o: ${project.manutencao?.length || 0}<br>
                                Partida: ${project.procedimentoPartida?.length || 0}
                            </div>
                        </div>
                    `
              )
              .join('');

            document.getElementById('projects-container').innerHTML =
              projectsHtml;
          } else {
            document.getElementById('projects-container').innerHTML =
              '<p>Nenhum projeto encontrado</p>';
          }
          showResponse(data);
        } catch (error) {
          showResponse({ error: error.message }, true);
        }
      }

      // Selecionar projeto
      function selectProject(projectId) {
        selectedProjectId = projectId;
        loadProjects(); // Recarregar para destacar sele√ß√£o
      }

      // Exportar projeto
      async function exportProject() {
        if (!selectedProjectId) {
          showResponse({ error: 'Selecione um projeto para exportar' }, true);
          return;
        }

        try {
          const response = await fetch(
            `${API_BASE}/${selectedProjectId}/export-csv`
          );

          if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `projeto_${selectedProjectId}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            showResponse({
              success: true,
              message: 'Projeto exportado com sucesso',
            });
          } else {
            const data = await response.json();
            showResponse(data, true);
          }
        } catch (error) {
          showResponse({ error: error.message }, true);
        }
      }

      // Duplicar projeto
      async function duplicateProject() {
        if (!selectedProjectId) {
          showResponse({ error: 'Selecione um projeto para duplicar' }, true);
          return;
        }

        const newName = prompt('Nome para o projeto duplicado:');
        if (!newName) return;

        try {
          const response = await fetch(
            `${API_BASE}/${selectedProjectId}/duplicate`,
            {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                name: newName,
                description: `Projeto duplicado de ${selectedProjectId}`,
              }),
            }
          );
          const data = await response.json();
          showResponse(data);

          if (data.success) {
            loadProjects(); // Recarregar lista
          }
        } catch (error) {
          showResponse({ error: error.message }, true);
        }
      }

      // Excluir projeto
      async function deleteProject() {
        if (!selectedProjectId) {
          showResponse({ error: 'Selecione um projeto para excluir' }, true);
          return;
        }

        if (!confirm('Tem certeza que deseja excluir este projeto?')) {
          return;
        }

        try {
          const response = await fetch(`${API_BASE}/${selectedProjectId}`, {
            method: 'DELETE',
          });
          const data = await response.json();
          showResponse(data);

          if (data.success) {
            selectedProjectId = null;
            loadProjects(); // Recarregar lista
          }
        } catch (error) {
          showResponse({ error: error.message }, true);
        }
      }

      // Carregar dados iniciais
      window.onload = function () {
        loadStats();
        loadProjects();
      };
    </script>
  </body>
</html>
