// Data Seeder (Clean Architecture)
require('dotenv').config({ path: './backend/.env' });

// Infrastructure
const DatabaseConnection = require('./backend/src/infrastructure/database/DatabaseConnection');
const MongoProjectRepositoryClean = require('./backend/src/infrastructure/repositories/MongoProjectRepositoryClean');

// Domain
const ProjectUseCasesClean = require('./backend/src/domain/usecases/ProjectUseCasesClean');
const Project = require('./backend/src/domain/entities/ProjectClean');
const Activity = require('./backend/src/domain/entities/Activity');

/**
 * Data seeder for populating the database with real project data
 * Uses Clean Architecture components
 */
class EPUGestaoDataSeeder {
  constructor() {
    console.log(
      '\nüå± Initializing EPU-Gest√£o Data Seeder (Clean Architecture)...'
    );

    this.database = new DatabaseConnection();
    this.projectRepository = new MongoProjectRepositoryClean();
    this.projectUseCases = new ProjectUseCasesClean(this.projectRepository);
  }

  async seed() {
    try {
      console.log('\nüöÄ Starting data seeding process...\n');

      // Connect to database
      console.log('üìä Connecting to database...');
      await this.database.connect();
      console.log('‚úÖ Database connected successfully');

      // Clear existing data (optional)
      if (process.env.CLEAR_EXISTING_DATA === 'true') {
        console.log('\nüßπ Clearing existing data...');
        await this.clearExistingData();
        console.log('‚úÖ Existing data cleared');
      }

      // Create comprehensive project data
      console.log('\nüìù Creating comprehensive project data...');
      const projects = await this.createProjectsData();

      // Seed projects
      console.log('\nüå± Seeding projects...');
      const seededProjects = [];

      for (const projectData of projects) {
        console.log(`   üìÅ Creating project: ${projectData.name}`);
        const result = await this.projectUseCases.createProject(projectData);

        if (result.success) {
          seededProjects.push(result.data);
          console.log(
            `   ‚úÖ Created: ${result.data.name} (ID: ${result.data.id})`
          );
          console.log(`      - ${result.data.activities.length} activities`);
          console.log(`      - Progress: ${result.data.progress.toFixed(1)}%`);
        } else {
          console.error(`   ‚ùå Failed to create project: ${result.message}`);
        }
      }

      // Display summary
      console.log('\nüìä Seeding Summary:');
      console.log('='.repeat(50));
      console.log(`üéØ Projects seeded: ${seededProjects.length}`);

      seededProjects.forEach((project, index) => {
        const stats = project.getStatistics();
        console.log(`\n${index + 1}. ${project.name}`);
        console.log(`   üÜî ID: ${project.id}`);
        console.log(`   üìà Progress: ${project.progress.toFixed(1)}%`);
        console.log(`   üèÉ Activities: ${stats.overview.totalActivities}`);
        console.log(`   ‚úÖ Completed: ${stats.overview.completedActivities}`);
        console.log(
          `   üîß In Progress: ${stats.overview.inProgressActivities}`
        );
        console.log(`   üìä By Type:`);
        console.log(`      - Parada: ${stats.typeBreakdown.parada.total}`);
        console.log(
          `      - Manuten√ß√£o: ${stats.typeBreakdown.manutencao.total}`
        );
        console.log(`      - Partida: ${stats.typeBreakdown.partida.total}`);
      });

      console.log('\nüéâ Data seeding completed successfully!');
      return seededProjects;
    } catch (error) {
      console.error('\nüí• Seeding failed:', error);
      throw error;
    } finally {
      // Always disconnect
      await this.database.disconnect();
      console.log('üìä Database disconnected');
    }
  }

  async clearExistingData() {
    try {
      // This would clear the ProjectClean collection
      const count = await this.projectRepository.count();
      console.log(`   Found ${count} existing projects`);

      if (count > 0) {
        console.log('   ‚ö†Ô∏è Clearing existing data...');
        // Implementation depends on your repository - for now just log
        console.log(
          '   ‚ÑπÔ∏è Existing data clearing not implemented - will create alongside existing data'
        );
      }
    } catch (error) {
      console.error('Error clearing existing data:', error);
    }
  }

  async createProjectsData() {
    const projects = [];

    // Project 1: Comprehensive Industrial Plant Maintenance
    projects.push({
      name: 'Parada Geral da Planta Industrial - 2025',
      description:
        'Parada programada para manuten√ß√£o completa da planta industrial, incluindo todos os equipamentos cr√≠ticos e sistemas auxiliares.',
      status: 'active',
      priority: 'high',
      owner: 'EPU-Gest√£o System',
      startDate: new Date('2025-01-15'),
      deadline: new Date('2025-02-28'),
      budget: 2500000,
      location: 'Planta Industrial Principal',
      category: 'maintenance',
      tags: ['parada-geral', 'manutencao', 'critico', '2025'],
      activities: [
        // Parada Activities
        new Activity({
          type: 'parada',
          name: 'P√°tio de Alimenta√ß√£o',
          planned: 100,
          real: 75.2,
          image: '/static/images/frentes/patioAlimentacao.png',
          description:
            'Interrup√ß√£o controlada do sistema de alimenta√ß√£o da planta',
          priority: 'high',
          estimatedHours: 24,
          actualHours: 20,
          assignedTo: 'Equipe Operacional A',
          tags: ['alimentacao', 'sistema-critico'],
          subActivities: [
            {
              name: 'Cortar Produ√ß√£o do P√°tio de Finos Parar P√°tio Vazio',
              planned: 100,
              real: 100,
              description: 'Interrup√ß√£o da produ√ß√£o no p√°tio de finos',
            },
            {
              name: 'Esvaziar e Limpar Chutes do Circuito de Alimenta√ß√£o',
              planned: 100,
              real: 85,
              description: 'Limpeza completa dos chutes de alimenta√ß√£o',
            },
            {
              name: 'Posicionar Emenda das Correias Conforme Necessidade',
              planned: 100,
              real: 60,
              description:
                'Ajuste e posicionamento das correias transportadoras',
            },
            {
              name: 'Realizar Bloqueio do Circuito do P√°tio de Finos',
              planned: 100,
              real: 45,
              description: 'Bloqueio de seguran√ßa do circuito',
            },
          ],
        }),

        new Activity({
          type: 'parada',
          name: 'Sistema de Secagem',
          planned: 100,
          real: 88.5,
          image: '/static/images/frentes/secagem.png',
          description: 'Parada controlada do sistema de secagem industrial',
          priority: 'high',
          estimatedHours: 18,
          actualHours: 16,
          assignedTo: 'Equipe T√©rmica',
          tags: ['secagem', 'temperatura'],
          subActivities: [
            {
              name: 'Desligar e Resfriar Queimadores 1SM6GG',
              planned: 100,
              real: 100,
              description: 'Desligamento seguro dos queimadores principais',
            },
            {
              name: 'Realizar Purga do G√°s do Queimador',
              planned: 100,
              real: 95,
              description: 'Purga completa do sistema de g√°s',
            },
            {
              name: 'Realizar Bloqueio da Secagem',
              planned: 100,
              real: 70,
              description: 'Bloqueio de seguran√ßa do sistema de secagem',
            },
          ],
        }),

        // Manuten√ß√£o Activities
        new Activity({
          type: 'manutencao',
          name: 'Forno Industrial',
          planned: 100,
          real: 85.0,
          image: '/static/images/frentes/forno.png',
          description: 'Manuten√ß√£o preventiva e corretiva do forno principal',
          priority: 'urgent',
          estimatedHours: 72,
          actualHours: 68,
          assignedTo: 'Equipe Manuten√ß√£o Mec√¢nica',
          tags: ['forno', 'alta-temperatura', 'critico'],
          subActivities: [
            {
              name: 'Refrat√°rios',
              planned: 90,
              real: 80,
              description: 'Substitui√ß√£o e reparo de refrat√°rios',
            },
            {
              name: 'Sistema de Combust√£o',
              planned: 95,
              real: 90,
              description: 'Manuten√ß√£o do sistema de combust√£o',
            },
            {
              name: 'Isolamento T√©rmico',
              planned: 85,
              real: 85,
              description: 'Verifica√ß√£o e reparo do isolamento',
            },
          ],
        }),

        new Activity({
          type: 'manutencao',
          name: 'Moinho Principal',
          planned: 95,
          real: 92.0,
          image: '/static/images/frentes/moinho.png',
          description: 'Manuten√ß√£o completa do moinho de produ√ß√£o',
          priority: 'high',
          estimatedHours: 48,
          actualHours: 45,
          assignedTo: 'Equipe Manuten√ß√£o Mec√¢nica',
          tags: ['moinho', 'producao'],
          subActivities: [
            {
              name: 'Revestimento',
              planned: 90,
              real: 95,
              description: 'Troca do revestimento interno do moinho',
            },
            {
              name: 'Sistema de Lubrifica√ß√£o',
              planned: 80,
              real: 88,
              description: 'Manuten√ß√£o do sistema de lubrifica√ß√£o',
            },
            {
              name: 'Mancais e Rolamentos',
              planned: 100,
              real: 93,
              description: 'Verifica√ß√£o e troca de mancais',
            },
          ],
        }),

        new Activity({
          type: 'manutencao',
          name: 'Precipitadores Eletrost√°ticos',
          planned: 88,
          real: 78.0,
          image: '/static/images/frentes/precipitador.png',
          description:
            'Manuten√ß√£o dos precipitadores para controle de emiss√µes',
          priority: 'medium',
          estimatedHours: 36,
          actualHours: 40,
          assignedTo: 'Equipe El√©trica',
          tags: ['precipitador', 'ambiental', 'eletrico'],
          subActivities: [
            {
              name: 'Eletrodos de Descarga',
              planned: 85,
              real: 75,
              description: 'Limpeza e ajuste dos eletrodos',
            },
            {
              name: 'Sistema de Vibra√ß√£o',
              planned: 90,
              real: 80,
              description: 'Manuten√ß√£o do sistema de vibra√ß√£o',
            },
            {
              name: 'Isoladores Cer√¢micos',
              planned: 90,
              real: 79,
              description: 'Verifica√ß√£o dos isoladores',
            },
          ],
        }),

        // Partida Activities
        new Activity({
          type: 'partida',
          name: 'Ventiladores Principais',
          planned: 85,
          real: 68.0,
          image: '/static/images/frentes/ventilador.png',
          description: 'Partida e comissionamento dos ventiladores principais',
          priority: 'medium',
          estimatedHours: 16,
          actualHours: 18,
          assignedTo: 'Equipe Operacional B',
          tags: ['ventilador', 'partida'],
          subActivities: [
            {
              name: 'Teste de Rota√ß√£o',
              planned: 80,
              real: 70,
              description: 'Teste de rota√ß√£o em vazio',
            },
            {
              name: 'Verifica√ß√£o de Vibra√ß√µes',
              planned: 90,
              real: 65,
              description: 'Medi√ß√£o e an√°lise de vibra√ß√µes',
            },
            {
              name: 'Teste de Carga',
              planned: 85,
              real: 69,
              description: 'Teste com carga progressiva',
            },
          ],
        }),

        new Activity({
          type: 'partida',
          name: 'Sistema de Controle',
          planned: 95,
          real: 72.0,
          image: '/static/images/frentes/controle.png',
          description: 'Comissionamento do sistema de controle automatizado',
          priority: 'high',
          estimatedHours: 24,
          actualHours: 28,
          assignedTo: 'Equipe Automa√ß√£o',
          tags: ['controle', 'automacao', 'software'],
          subActivities: [
            {
              name: 'Teste de IHM',
              planned: 100,
              real: 85,
              description: 'Teste da interface homem-m√°quina',
            },
            {
              name: 'Calibra√ß√£o de Sensores',
              planned: 90,
              real: 65,
              description: 'Calibra√ß√£o de todos os sensores',
            },
            {
              name: 'Teste de Intertravamentos',
              planned: 95,
              real: 67,
              description: 'Teste dos sistemas de seguran√ßa',
            },
          ],
        }),

        new Activity({
          type: 'partida',
          name: 'Teste Operacional Geral',
          planned: 100,
          real: 45.0,
          image: '/static/images/frentes/testeOperacional.png',
          description: 'Teste operacional integrado de toda a planta',
          priority: 'urgent',
          estimatedHours: 32,
          actualHours: 15,
          assignedTo: 'Equipe Multidisciplinar',
          tags: ['teste', 'operacional', 'integracao'],
          subActivities: [
            {
              name: 'Teste de Sequ√™ncia de Partida',
              planned: 100,
              real: 50,
              description: 'Teste da sequ√™ncia completa de partida',
            },
            {
              name: 'Teste de Capacidade',
              planned: 100,
              real: 40,
              description: 'Teste de capacidade nominal',
            },
            {
              name: 'Ajuste de Par√¢metros',
              planned: 100,
              real: 45,
              description: 'Ajuste fino dos par√¢metros operacionais',
            },
          ],
        }),
      ],
    });

    // Project 2: Modernization Project
    projects.push({
      name: 'Moderniza√ß√£o da Linha de Produ√ß√£o B',
      description:
        'Projeto de moderniza√ß√£o tecnol√≥gica da linha de produ√ß√£o B, incluindo automa√ß√£o e efici√™ncia energ√©tica.',
      status: 'active',
      priority: 'medium',
      owner: 'Departamento de Engenharia',
      startDate: new Date('2025-02-01'),
      deadline: new Date('2025-04-30'),
      budget: 1800000,
      location: 'Linha de Produ√ß√£o B',
      category: 'modernization',
      tags: ['modernizacao', 'automacao', 'eficiencia'],
      activities: [
        new Activity({
          type: 'parada',
          name: 'Parada da Linha B',
          planned: 100,
          real: 35.0,
          description: 'Parada programada da linha de produ√ß√£o B',
          priority: 'high',
          estimatedHours: 8,
          actualHours: 3,
          assignedTo: 'Opera√ß√£o Linha B',
        }),

        new Activity({
          type: 'manutencao',
          name: 'Upgrade do Sistema de Automa√ß√£o',
          planned: 100,
          real: 15.0,
          description: 'Atualiza√ß√£o completa do sistema de automa√ß√£o',
          priority: 'high',
          estimatedHours: 120,
          actualHours: 18,
          assignedTo: 'Equipe Automa√ß√£o',
        }),

        new Activity({
          type: 'partida',
          name: 'Comissionamento Nova Automa√ß√£o',
          planned: 100,
          real: 0.0,
          description: 'Comissionamento e testes do novo sistema',
          priority: 'medium',
          estimatedHours: 40,
          actualHours: 0,
          assignedTo: 'Equipe Comissionamento',
        }),
      ],
    });

    return projects;
  }
}

// Execute seeding if run directly
if (require.main === module) {
  const seeder = new EPUGestaoDataSeeder();

  seeder
    .seed()
    .then((projects) => {
      console.log(`\nüéâ Seeding completed successfully!`);
      console.log(`üìä ${projects.length} projects created`);
      console.log('\nüìù You can now test the endpoints:');
      console.log('   GET /api/projects');
      console.log('   GET /api/projects/:id/frentes');
      console.log('   GET /api/projects/:id/statistics');
      process.exit(0);
    })
    .catch((error) => {
      console.error('\nüí• Seeding failed:', error.message);
      process.exit(1);
    });
}

module.exports = EPUGestaoDataSeeder;
